<% @current_user ||= User.find_by(id: session[:user_id]) %> <!-- This line gets the user's ID**Needed for EDIT**-->
<!DOCTYPE html>
<html class="test1" lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/bootstrap.css">
</head>
<%# THIS IS THE TOP BORDER %>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/users/info" style="padding:10px; text-shadow:5px 2px 0 rgba(0,204,102,1);font-weight:bold;color:white;letter-spacing:0pt;word-spacing:2pt;font-size:33px;text-align:left;font-family:arial black, sans-serif;line-height:1;">SIGHTSEER</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Menu <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><%= link_to 'Go to Route Planner', map_path %></li>
            <li><%= link_to 'New User', new_user_url %></li>
            <li><%= link_to 'Edit User', edit_user_url(@current_user.id) %></li>
            <li><%= link_to 'Sign Out', login_url %></li>
          </ul>
        </li>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<% if notice%>
<p id = "notice"><%= notice%></p>
<% end %>

<h2 style= "color:black"> Welcome <%= session[:user_username] %>, To SightSeers!</h2>

<body class = "test2">

    <!-- Full Page Image Background Carousel Header -->
    <header id="myCarousel" class="carousel slide">
        <!-- Indicators -->
        <ol class="carousel-indicators">
            <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
            <li data-target="#myCarousel" data-slide-to="1"></li>
            <li data-target="#myCarousel" data-slide-to="2"></li>
        </ol>

        <!-- Wrapper for Slides -->
        <div class="carousel-inner">
            <div class="item active">
                <!-- Set the first background image using inline CSS below. -->
                <div class="fill" style="background-image:url(/assets/slide1.jpg);"></div>
                <div class="carousel-caption">
                    <h2>Nightly Scenery</h2>
                </div>
            </div>
            <div class="item">
                <!-- Set the second background image using inline CSS below. -->
                <div class="fill" style="background-image:url(/assets/slide2.jpg);"></div>
                <div class="carousel-caption">
                    <h2>Vancouver</h2>
                </div>
            </div>
            <div class="item">
                <!-- Set the third background image using inline CSS below. -->
                <div class="fill" style="background-image:url(/assets/slide3.jpg);"></div>
                <div class="carousel-caption">
                    <h2>SO MUCH TO SEE AND DO</h2>
                </div>
            </div>
        </div>
        <!-- Controls -->
        <a class="left carousel-control" href="#myCarousel" data-slide="prev">
            <span class="icon-prev"></span>
        </a>
        <a class="right carousel-control" href="#myCarousel" data-slide="next">
            <span class="icon-next"></span>
        </a>
    </header>
<%# SLIDE SHOW END %>
<div class="container-fluid">

<div class="row">
    <div class="col-md-12">
        <p id="newLine">______________________________________________________________</p>
    </div>
    <div class="col-md-12">
        <h2 style="text-align:center; position:relative; top:30px;">POPULAR CHOICES</h2>
    </div>
</div>
<div class="row" id="pictureLinks" style="padding-top:20px;">

    <div class="col-md-2">
        <div class="crop">
            <a id="grind" href="https://www.grousemountain.com/grousegrind">
                <img id="pictures" src="assets/choices/grind.jpg" alt="Grouse Grind">
            </a>
        </div>
    </div>

    <div class="col-md-2">
        <div class="crop">
            <a id="bridge" href="https://www.capbridge.com/">
                <img id="pictures" src="assets/choices/bridge.jpg" alt="Suspension Bridge">
            </a>
        </div>
    </div>

    <div class="col-md-2">
        <div class="crop">
            <a id="science" href="https://www.scienceworld.ca/">
                <img id="pictures" src="assets/choices/science.jpg" alt="Science World">
            </a>
        </div>
    </div>

    <div class="col-md-2">
        <div class="crop">
            <a id="art" href="http://www.vanartgallery.bc.ca/">
                <img id="pictures" src="assets/choices/art.jpg" alt="Art Gallery">
            </a>
        </div>
    </div>

    <div class="col-md-2">
        <div class="crop">
            <a id="island" href="http://granvilleisland.com/">
                <img id="pictures" src="assets/choices/island.jpg" alt="Granville Island">
            </a>
        </div>
    </div>

    <div class="col-md-2">
        <div class="crop">
            <a id="aquarium" href="http://www.vanaqua.org/">
                <img id="pictures" src="assets/choices/aquarium.jpg" alt="Vancouver Aquarium">
            </a>
        </div>
    </div>

</div>


</div>

    <%#START OF MAP PORTION %>

    <div id = "mapContainer">
      
      <div id="map"></div>

      <div id="rightpanel">

        <div class="infobox">
          <p><b>Search For: </b></p>
          <p>
            <select id="destinationType">
              <option selected disabled>Choose Destination Type</option>
              <option value="airport">Airports</option>
              <option value="amusement_park">Amusement Parks</option>
              <option value="aquarium">Aquariums</option>
              <option value="art_gallery">Art Galleries</option>
              <option value="bakery">Bakeries</option>
              <option value="bar">Bars</option>
              <option value="book_store">Book Stores</option>
              <option value="bowling_alley">Bowling Alleys</option>
              <option value="cafe">Cafes</option>
              <option value="campground">Campgrounds</option>
              <option value="casino">Casinos</option>
              <option value="clothing_store">Clothing Stores</option>
              <option value="movie_theater">Movie Theatres</option>
              <option value="museum">Museums</option>
              <option value="night_club">Night Clubs</option>
              <option value="park">Parks</option>
              <option value="restaurant">Restaurants</option>
              <option value="shopping_mall">Shopping Malls</option>
              <option value="spa">Spas</option>
              <option value="stadium">Stadiums</option>
              <option value="travel_agency">Travel Agencies</option>
              <option value="university">Universities</option>
              <option value="zoo">Zoos</option>
            </select>
          </p>
        </div>

        <div class="infobox">
          <p><b>Mode of Transportation</b></p>
          <p>
            <select id="travelMode">
              <option value="DRIVING">Driving</option>
              <option value="TRANSIT">Public Transit</option>
              <option value="WALKING">On Foot</option>
            </select>
          </p>

          <p><b>Start:</b></p>
          <p><span id="startPos">A </span><input type="text" id="start" value="SFU, BC"></p>
          <br>

          <div id="tripBox">

            <p><b>Your Trip: </b></p>
            <table id="trip">
            </table>
          </div>

          <br>
          <p><b>End:</b></p>
          <p><span id="endPos"></span><input type="text" id="end" value="SFU, BC"></p>
          <br>

          <button id="calcRouteButton">Calculate Route</button>
          <p id="errorBox"></p>
        </div>
      </div>
    </div>

    <script>
      var map;
      var places = [];
      var infowindows =[];
      var markers = [];
      var waypts = [];
      var wayptsT = [];
      var tripTable = document.getElementById("trip");
      var tableIndex = 0;
      var Alpha = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];

      //waypoints are disabled when public transit is selected - limitation of Google Maps API
      var hideWaypts = function() {
        if (document.getElementById('travelMode').value == "TRANSIT") {
          document.getElementById('tripBox').style.display = 'none';
        } else {
          document.getElementById('tripBox').style.display = 'initial';
        }
      }
      document.getElementById('travelMode').addEventListener('change', hideWaypts);



      function initMap() {
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;

        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 49.278947, lng: -122.916525},
          zoom: 11
        });
        directionsDisplay.setMap(map);

        var callCalcRoute = function() {
          calcRoute(directionsService, directionsDisplay);
        }

        document.getElementById('calcRouteButton').addEventListener("click", callCalcRoute);

        /*var makeRoute = function() {
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        };*/

        //document.getElementById('submit').addEventListener("click", makeRoute);

        var service = new google.maps.places.PlacesService(map);
        var doSearch = function() {
          var dtype = document.getElementById('destinationType').value;
          search(service, dtype);
        };

        document.getElementById('destinationType').addEventListener('change', doSearch);

      }

      //Finds search results and passes them to callback function
      function search(service, dtype) {
        service.nearbySearch({
          location: {lat: 49.278947, lng: -122.916525},
          radius: 50000,
          type: [dtype]
        }, callback);
      }

      //called by the search funtion. Calls createMarker for each search result.
      function callback(results, status) {
        clearMarkers();
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            places[i] = results[i];
            markers[i] = createMarker(i);
          }
        }
      }

      //creates a marker and an Infowindow that opens when the marker is clicked
      function createMarker(i) {
        var marker = new google.maps.Marker({
          map: map,
          position: places[i].geometry.location,
          animation: google.maps.Animation.DROP
        });

        /*
        //Will need to get this working for infowindows to have things like phone number or price
        places.getDetails({
          placeId: places[i].place_id
        },
        function(placeResults, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            places[i] = placeResults;
          }
        });
        */

        infowindows[i] = new google.maps.InfoWindow();

        google.maps.event.addListener(marker, 'click', function() {
          var IWcontent = "<b>Location Name: </b>" + places[i].name + "<br>" +
                          "<p>Rating: " + places[i].rating + "</p>" +
                          "<button id='addDest' type='button' onclick='addDest("+i+")'>Add to Trip</button>";

          infowindows[i].setContent(IWcontent);

          clearIWs();
          infowindows[i].open(map, marker);
        });
        return marker;
      }

      function addDest(i) {
        //Doesn't allow more than 8 waypoints to be added - the limit imposed by Google Maps API
        if (tableIndex < 8) {
          //Doesn't allow the same destination to be added more than once
          for (var j = 0; j < tableIndex; j++) {
            if (tripTable.rows[j].cells[1].innerHTML == places[i].name) {
              window.alert(places[i].name + ' has already been added to the trip.');
              return;
            }
          }
          //add the destination location to the waypts list
          waypts.push({
            location: places[i].geometry.location,
            stopover: true
          });
          //add the destination name to the trip table
          var row = tripTable.insertRow(tableIndex++);
          var cell0 = row.insertCell(0);
          cell0.innerHTML = '';
          cell0.style.padding = '5px';
          var cell1 = row.insertCell(1);
          cell1.innerHTML = places[i].name;
          cell1.style.padding = '5px';
          var cell2 = row.insertCell(2);
          cell2.innerHTML = '<input type="button" value="Delete" onclick="removeDest(this)">'
          cell2.style.padding = '5px';
        }else{
          window.alert('Maximum Number of Destinations added!');
        }
      }

      function removeDest(r) {
        var i = r.parentNode.parentNode.rowIndex;
        //remove the place from the waypts array
        waypts.splice(i, 1);
        //remove the place from the trip table
        tripTable.deleteRow(i);
        tableIndex--;
      }

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
            if (markers[i]) {
                markers[i].setMap(null);
            }
        }
        markers = [];
      }

      //closes any opened Infowindows. Called when route is being displayed.
      function clearIWs() {
        for (var i = 0; i < infowindows.length; i++) {
          infowindows[i].close();
        }
      }

      function calcRoute(directionsService, directionsDisplay) {
        clearMarkers();
        document.getElementById("destinationType").value = "";

        if (document.getElementById('travelMode').value == "TRANSIT") {
          directionsService.route({
            origin: document.getElementById("start").value,
            destination: document.getElementById("end").value,
            travelMode: google.maps.TravelMode[document.getElementById("travelMode").value]
          },
          function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
              document.getElementById('errorBox').innerHTML = '';
              directionsDisplay.setDirections(response);
            } else {
              document.getElementById('errorBox').innerHTML = 'Error: ' + status;
            }
          })
        }else{
          directionsService.route({
            origin: document.getElementById("start").value,
            destination: document.getElementById("end").value,
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode[document.getElementById("travelMode").value]
          },
          function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
              document.getElementById('errorBox').innerHTML = '';
              orderTripTable(response);
              directionsDisplay.setDirections(response);
            } else {
              document.getElementById('errorBox').innerHTML = 'Error: ' + status;
            }
          })
        }
      }

      function orderTripTable(response) {
        for (var j = 0; j < tripTable.rows.length; j++) {
          var OrderCell = tripTable.rows[response.routes[0].waypoint_order[j]].cells[0];
          OrderCell.innerHTML = Alpha[j+1];
          OrderCell.style.fontWeight = 'bold';
        }
        document.getElementById('startPos').style.display = 'initial';
        document.getElementById('endPos').style.display = 'initial';
        document.getElementById('endPos').innerHTML = Alpha[response.geocoded_waypoints.length - 1] + ' ';
      }

      /*function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var wayptsAll = document.getElementsByName('waypoint');

        //Waypoints are disabled if user is using public transit
        //Adds selected waypoints to waypts
        if (document.getElementById('travelMode').value !== "TRANSIT") {
          for (var i = 0; i < wayptsAll.length; i++) {
            if (wayptsAll[i].checked) {
              waypts.push({
                location: wayptsAll[i].value,
                stopover: true
              });
            }
          }
        }


        directionsService.route({
          origin: document.getElementById("start").value,
          destination: document.getElementById("end").value,
          waypoints: waypts,
          optimizeWaypoints: true,
          travelMode: google.maps.TravelMode[document.getElementById("travelMode").value]
        },
        function(response, status) {
          if (status === google.maps.DirectionsStatus.OK) {
            document.getElementById('errorBox').innerHTML = '';
            directionsDisplay.setDirections(response);
          } else {
            document.getElementById('errorBox').innerHTML = 'Error: ' + status;
          }
        })
      }*/



    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaU5DbGvX_-OOZwj-az4zT4iC6gp8MmQQ&libraries=places&callback=initMap"
    async defer></script>

    <!--
    <div id="locationField" style="position:relative; top:200px; left:25%; width:15%; height:50px;">
      <input id="autocomplete" placeholder="Enter a city" type="text" style="height:50px; font-size:150%;" />
    </div>

    <div id="controls" style="position:relative; top:150px; left:45%; width:15%;">
      <select id="country">
        <option value="ca" selected>None</option>
        <option value="all">All</option>
        <option value="ca">Canada</option>
      </select>
    </div>


    <div id = "mapContainer">
    <div id="map" style="height: 100%; color:black; width: 100%;"></div>
    </div>


    <div id="listing" style="position:relative; left:87%; top:-665px">
      <table id="resultsTable">
        <tbody id="results"></tbody>
      </table>
    </div>

    <div style="display: none">
      <div id="info-content">
        <table>
          <tr id="iw-url-row" class="iw_table_row">
            <td id="iw-icon" class="iw_table_icon"></td>
            <td id="iw-url"></td>
          </tr>
          <tr id="iw-address-row" class="iw_table_row">
            <td class="iw_attribute_name">Address:</td>
            <td id="iw-address"></td>
          </tr>
          <tr id="iw-phone-row" class="iw_table_row">
            <td class="iw_attribute_name">Telephone:</td>
            <td id="iw-phone"></td>
          </tr>
          <tr id="iw-rating-row" class="iw_table_row">
            <td class="iw_attribute_name">Rating:</td>
            <td id="iw-rating"></td>
          </tr>
          <tr id="iw-website-row" class="iw_table_row">
            <td class="iw_attribute_name">Website:</td>
            <td id="iw-website"></td>
          </tr>
        </table>
      </div>
    </div>
    -->

</body>
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaU5DbGvX_-OOZwj-az4zT4iC6gp8MmQQ&libraries=places&callback=initMap"async defer></script> -->
<!-- <script src="assets/home.js"></script> -->
<script src="/assets/bootstrap.js"></script>
</html>
